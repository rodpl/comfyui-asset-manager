# ComfyUI Asset Manager - Developer Memory Bank

## Project Overview

**Purpose**: A ComfyUI extension for comprehensive asset management, providing a user-friendly interface for organizing local assets, browsing/downloading models from external platforms (CivitAI, HuggingFace), and managing ComfyUI outputs.

**Architecture**: Hybrid Python backend + React frontend extension using hexagonal architecture (ports and adapters pattern) that integrates seamlessly into ComfyUI's sidebar interface.

**Inspiration**: Based on Stability Matrix application's asset management capabilities.

**Current Version**: 0.1.0 (Early Development)

## Architecture & Design Patterns

### Hexagonal Architecture (Ports and Adapters)
- **Domain Core**: Pure business logic without infrastructure dependencies
  - Entities: `Model`, `Folder`, `ExternalMetadata` (CivitAI, HuggingFace)
  - Services: `ModelService`, `FolderService`, `MetadataService`
- **Driving Ports**: Define what the application can do (API)
  - `ModelManagementPort`, `FolderManagementPort`
- **Driven Ports**: Define what the application needs (SPI)
  - `ModelRepositoryPort`, `ExternalMetadataPort`, `CachePort`
- **Adapters**: Infrastructure implementations
  - Driving: Web API adapters, CLI adapters
  - Driven: File system adapters, external API clients, cache implementations

### Technology Stack

#### Backend (Python)
- **Language**: Python 3.8+ with Poetry dependency management
- **Architecture**: Hexagonal/Clean Architecture with ports and adapters
- **Web Framework**: aiohttp integration with ComfyUI's PromptServer
- **ComfyUI Integration**: Extension registration via NODE_CLASS_MAPPINGS
- **Testing**: pytest with coverage (70% minimum), organized by domain layers

#### Frontend (React/TypeScript)
- **Framework**: React 18 with TypeScript (strict mode)
- **Build Tool**: Vite with custom ComfyUI integration
- **Package Manager**: pnpm for Node.js dependencies
- **Styling**: CSS modules + ComfyUI-provided CSS classes (NO external frameworks)
- **Internationalization**: i18next with react-i18next (en, zh support)
- **Testing**: Vitest + React Testing Library with jsdom
- **Code Quality**: ESLint + Prettier with auto-import sorting

## Project Structure

```
├── __init__.py                    # ComfyUI extension entry point
├── pyproject.toml                 # Python project config + ComfyUI registry metadata
├── src/                           # Python backend (hexagonal architecture)
│   ├── domain/
│   │   ├── entities/              # Core business objects (Model, Folder, etc.)
│   │   ├── services/              # Business logic (ModelService, etc.)
│   │   └── ports/
│   │       ├── driving/           # Primary ports (use cases)
│   │       └── driven/            # Secondary ports (infrastructure needs)
│   └── adapters/
│       ├── driving/               # Primary adapters (Web API, CLI)
│       └── driven/                # Secondary adapters (File system, External APIs)
├── ui/                            # React frontend
│   ├── src/
│   │   ├── main.tsx              # ComfyUI extension registration
│   │   ├── App.tsx               # Main component with tab navigation
│   │   ├── features/             # Feature-based organization
│   │   │   ├── local-assets/     # Local asset management
│   │   │   ├── model-browser/    # Model browsing and download
│   │   │   └── outputs/          # Output gallery
│   │   └── utils/i18n.ts         # Internationalization setup
│   ├── public/locales/           # Translation files (en, zh)
│   └── package.json              # Frontend dependencies
├── dist/                         # Built frontend assets (served by backend)
├── tests/                        # Python tests (mirrors src/ structure)
└── docs/development/             # Development documentation
```

## Development Workflow

### Setup & Commands
```bash
# Quick setup
./setup.sh                       # Automated setup for Python + Node.js

# Frontend development
cd ui/
pnpm install
pnpm run dev                     # Development server with hot reload
pnpm run build                   # Production build
pnpm run watch                   # Watch mode for development
pnpm run lint                    # ESLint check
pnpm run lint:fix                # Auto-fix ESLint issues
pnpm run format                  # Prettier formatting
pnpm run typecheck               # TypeScript type checking
pnpm run test                    # Run tests
pnpm run test:watch              # Watch mode testing

# Python backend development
poetry install --with dev        # Install dependencies
poetry run pytest               # Run all tests
poetry run pytest --cov=src     # Run tests with coverage
poetry run pytest tests/domain/ # Run domain tests only
```

### Build Process
1. Frontend builds to `dist/asset_manager/` directory
2. Localization files served from `dist/locales/`
3. Backend serves built assets via aiohttp routes (`/asset_manager/`, `/locales/`)
4. ComfyUI loads extension via `__init__.py`

## Code Standards & Conventions

### Python Conventions
- **Style**: PEP 8, Black formatting, 88 character line width
- **Type Hints**: Required for all public functions
- **Architecture**: Strict hexagonal architecture boundaries
- **Testing**: Function-based tests, pytest fixtures, Arrange-Act-Assert pattern
- **Naming**: snake_case for variables/functions, PascalCase for classes

### TypeScript/React Conventions
- **Strict TypeScript**: `noUnusedLocals`, `noUnusedParameters` enabled
- **Components**: Functional components with hooks, one component per file
- **Naming**: camelCase for variables/functions, PascalCase for components
- **State Management**: React hooks (useState, useEffect, useCallback)
- **Imports**: Auto-sorted with `@trivago/prettier-plugin-sort-imports`
- **Testing**: Vitest with React Testing Library, co-located test files

## ComfyUI Integration Specifics

### Extension Registration
- **Sidebar Tab**: Registered via `app.extensionManager.registerSidebarTab()`
- **Icon**: Uses PrimeVue icons (`pi pi-server`)
- **About Page**: Adds GitHub badge to ComfyUI about page
- **Initialization**: Waits for `window.app` availability with timeout fallback

### Critical Styling Constraints ⚠️
- **NO External CSS Frameworks**: Cannot load Bootstrap, Material-UI, Ant Design, etc.
- **Use ComfyUI's CSS**: Must use CSS classes already provided by ComfyUI
- **Available Frameworks**: TailwindCSS and PrimeVue (already loaded by ComfyUI)
- **Strategy**: Inspect ComfyUI with dev tools to find available CSS classes
- **Custom CSS**: Allowed but must not conflict with ComfyUI's styling

### API Routes
- **Prefix**: All routes must start with `/asset_manager/` to avoid conflicts
- **Static Assets**: Served from `/asset_manager/` and `/locales/`
- **RESTful Design**: Follow REST conventions for resource naming

## Current Implementation Status

### ✅ Completed
- **Domain Core**: Complete entities (Model, Folder, ExternalMetadata) with validation
- **Domain Services**: ModelService, FolderService, MetadataService with business logic
- **Ports**: All driving and driven port interfaces defined
- **Driven Adapters**: FileSystemModelAdapter, ComfyUIFolderAdapter implemented
- **Frontend Structure**: React app with tab navigation, i18n setup
- **ComfyUI Integration**: Extension registration, sidebar tab, static serving
- **Development Toolchain**: Complete setup with linting, testing, formatting

### 🚧 In Progress
- **Driving Adapters**: Web API adapters for frontend communication
- **External Metadata**: CivitAI and HuggingFace API integration
- **Caching**: Local metadata caching for performance
- **UI Components**: Asset grid views, search/filter functionality

### 📋 TODO
- **Local Asset Management**: Complete UI for browsing/organizing models
- **Model Browser**: External platform integration for downloads
- **Output Gallery**: ComfyUI output management and organization
- **Drag & Drop**: Integration with ComfyUI workflow nodes

## Feature Specifications

### Local Asset Management
- **Folder Structure**: Uses ComfyUI's existing folder organization (checkpoints, loras, vae, etc.)
- **Asset Display**: Grid view with thumbnails, metadata, and search/filter
- **Metadata Enrichment**: External platform integration (CivitAI, HuggingFace)
- **User Management**: Custom tags, ratings, descriptions
- **Bulk Operations**: Multi-select for organizing large collections

### Model Browser & Discovery
- **Platform Integration**: Direct browsing of CivitAI and HuggingFace
- **One-Click Downloads**: Streamlined model acquisition
- **Metadata Preservation**: Maintain external metadata locally

### Output Gallery
- **Visual Gallery**: ComfyUI-generated image organization
- **Workflow Tracking**: Link outputs to generating workflows
- **Search & Filter**: Find outputs by metadata, date, workflow

## Testing Strategy

### Python Testing
- **Framework**: pytest with coverage reporting (70% minimum)
- **Organization**: Tests mirror `src/` structure in `tests/`
- **Markers**: `unit`, `integration`, `slow` for test categorization
- **Patterns**: Function-based tests, fixtures for setup, mocking for isolation

### Frontend Testing
- **Framework**: Vitest with React Testing Library
- **Environment**: jsdom for DOM simulation
- **Coverage**: JUnit XML output for CI/CD
- **Location**: `ui/src/__tests__/` directory

## Internationalization

### Structure
- **Files**: `ui/public/locales/{lang}/main.json`
- **Languages**: English (en), Chinese (zh) with fallback to English
- **Keys**: Hierarchical organization (app.title, tabs.localAssets, etc.)
- **Loading**: HTTP backend with retry logic

## Development Tips & Troubleshooting

### Common Issues
- **Build Failures**: Check TypeScript errors and ESLint warnings first
- **Extension Not Loading**: Verify ComfyUI app initialization timing
- **Styling Broken**: Ensure no custom CSS frameworks were imported
- **Missing Translations**: Check locale file structure and i18n config

### Best Practices
1. **Always run linting/formatting** before commits
2. **Follow hexagonal architecture** - keep domain pure
3. **Test components** with Vitest and React Testing Library
4. **Use browser dev tools** to find available ComfyUI CSS classes
5. **Prefix all API routes** with `/asset_manager/`
6. **Wait for app initialization** before registering features

### Development Scripts
- **`./dev_server.sh`**: Creates symlink and runs watch mode for ComfyUI integration
- **`./setup.sh`**: Automated setup for both Python and Node.js dependencies

## Memory Bank Context

This `.agent.md` file serves as the central memory bank for AI assistants working on this project. It consolidates information from:
- `.kiro/steering/` - Architecture, product, and technical guidelines
- `.kiro/specs/` - Feature specifications and requirements
- `docs/development/` - Implementation status and developer guides
- Current codebase analysis

**Update this file** when significant changes are made to architecture, tooling, or development processes to maintain AI assistant continuity.

---

*Last updated: Based on current implementation analysis and steering documentation*