# ComfyUI Asset Manager - Developer Guide

## Project Overview

**Purpose**: A ComfyUI extension for comprehensive asset management, providing a user-friendly interface for organizing local assets, browsing/downloading models from external platforms (CivitAI, HuggingFace), and managing ComfyUI outputs.

**Architecture**: Hybrid Python backend + React frontend extension that integrates seamlessly into ComfyUI's interface.

**Inspiration**: Based on Stability Matrix application's asset management capabilities.

## Technology Stack

### Backend
- **Language**: Python
- **Framework**: ComfyUI extension using `aiohttp` for web routes
- **Packaging**: `pyproject.toml` for project metadata
- **Integration**: Extends ComfyUI's native functionality via extension system

### Frontend
- **Framework**: React 18 with TypeScript
- **Bundler**: Vite with custom ComfyUI integration
- **Styling**: Standard CSS (adapts to ComfyUI's TailwindCSS + PrimeVue theme)
- **Internationalization**: i18next with react-i18next
- **Testing**: Vitest + React Testing Library
- **Code Quality**: ESLint + Prettier with strict TypeScript config

## Project Structure

### Key Directories
```
├── __init__.py                 # Python backend entry point
├── pyproject.toml             # Python project configuration
├── ui/                        # React frontend source
│   ├── src/
│   │   ├── App.tsx           # Main React component with tab navigation
│   │   ├── main.tsx          # ComfyUI extension registration
│   │   └── utils/i18n.ts     # Internationalization setup
│   ├── public/locales/       # Translation files
│   └── package.json          # Frontend dependencies
├── dist/                     # Built frontend assets (served by backend)
├── .kilocode/rules/memory-bank/  # AI assistant memory bank
└── docs/development/         # Development documentation
```

### Important Files
- **`__init__.py`**: Backend entry point, serves static assets and registers web routes
- **`ui/src/main.tsx`**: ComfyUI extension registration and React app initialization
- **`ui/src/App.tsx`**: Main UI with three tabs (Local Assets, Model Browser, Outputs)
- **`ui/vite.config.ts`**: Custom Vite config for ComfyUI integration
- **`pyproject.toml`**: Python project metadata for ComfyUI Registry

## Development Workflow

### Setup Commands
```bash
# Frontend development
cd ui/
npm install
npm run dev          # Development server
npm run build        # Production build
npm run watch        # Watch mode for development

# Code quality
npm run lint         # ESLint check
npm run lint:fix     # Auto-fix ESLint issues
npm run format       # Prettier formatting
npm run typecheck    # TypeScript type checking

# Testing
npm run test         # Run tests
npm run test:watch   # Watch mode testing
```

### Build Process
1. Frontend builds to `../dist/` directory (relative to ui/)
2. Backend serves built assets from `dist/` directory
3. ComfyUI loads extension via `__init__.py`

## Code Standards & Conventions

### TypeScript/React
- **Strict TypeScript**: Enabled with `noUnusedLocals` and `noUnusedParameters`
- **Component Structure**: Functional components with hooks
- **Styling**: CSS modules or standard CSS files co-located with components
- **State Management**: React hooks (useState, useEffect)
- **Imports**: Auto-sorted with `@trivago/prettier-plugin-sort-imports`

### Code Quality Rules
- **ESLint**: Strict configuration with React hooks rules
- **Prettier**: 100 character line width, single quotes, trailing commas
- **Unused Imports**: Automatically removed via eslint plugin
- **Testing**: Vitest with jsdom environment for React components

### Python
- **Extension Pattern**: Follow ComfyUI extension conventions
- **Web Routes**: Prefix all routes with `/asset_manager/` to avoid conflicts
- **Static Serving**: Serve React build artifacts and locale files

## ComfyUI Integration

### Extension Registration
- **Sidebar Tab**: Registered via `app.extensionManager.registerSidebarTab()`
- **Icon**: Uses PrimeVue icons (`pi pi-server`)
- **About Page**: Adds badge to ComfyUI about page with GitHub link

### Frontend Integration
- **Types**: Uses `@comfyorg/comfyui-frontend-types` for ComfyUI API types
- **Initialization**: Waits for `window.app` availability before mounting
- **Styling**: Adapts to ComfyUI's TailwindCSS + PrimeVue theme system

### Development Mode
- **Hot Reload**: Vite dev server with ComfyUI script rewriting
- **External Scripts**: ComfyUI scripts loaded from `http://127.0.0.1:8188/`
- **Build Output**: Structured for ComfyUI extension loading

## Internationalization

### Structure
- **Locale Files**: `ui/public/locales/{lang}/main.json`
- **Supported Languages**: English (en), Chinese (zh)
- **Fallback**: English with debug logging for missing keys
- **Loading**: HTTP backend with retry logic and fallback resources

### Adding New Languages
1. Create `ui/public/locales/{lang_code}/main.json`
2. Copy structure from existing locale file
3. Translate all values while keeping keys identical

## Testing Strategy

### Frontend Testing
- **Framework**: Vitest with React Testing Library
- **Environment**: jsdom for DOM simulation
- **Setup**: `src/setupTests.ts` for test configuration
- **Coverage**: JUnit XML output for CI/CD integration

### File Structure
- **Tests**: `ui/src/__tests__/` directory
- **Naming**: `*.test.tsx` for component tests
- **Utilities**: Co-located test utilities and mocks

## Memory Bank System

This project uses a comprehensive memory bank system for AI assistant continuity:

### Core Files (in `.kilocode/rules/memory-bank/`)
- **`brief.md`**: Project goals and key features (manually maintained)
- **`product.md`**: Problem solved and user experience goals
- **`context.md`**: Current state and next steps
- **`architecture.md`**: System architecture and technical decisions
- **`tech.md`**: Technology stack and development environment
- **`tasks.md`**: Documented workflows for repetitive tasks

### Usage
- AI assistant reads ALL memory bank files at task start
- Files provide context for development decisions and project state
- Update memory bank after significant changes or new patterns

## Best Practices

### Development
1. **Always run linting and formatting** before commits
2. **Follow existing code patterns** and component structure
3. **Test new components** with Vitest and React Testing Library
4. **Update translations** when adding new UI text
5. **Document repetitive tasks** in memory bank for future reference

### ComfyUI Extension
1. **Prefix all routes** with `/asset_manager/` to avoid conflicts
2. **Wait for app initialization** before registering extension features
3. **Use PrimeVue icons** for consistency with ComfyUI theme
4. **Adapt CSS classes** to work with ComfyUI's styling system

### Code Organization
1. **Co-locate related files** (component + styles + tests)
2. **Use TypeScript strictly** with proper type definitions
3. **Keep components focused** on single responsibilities
4. **Extract reusable logic** into custom hooks or utilities

## Current State

The project is in initial setup phase with:
- ✅ Basic Python backend serving React frontend
- ✅ Three-tab navigation structure (Local Assets, Model Browser, Outputs)
- ✅ ComfyUI extension registration and sidebar integration
- ✅ Internationalization framework with English/Chinese support
- ✅ Complete development toolchain (TypeScript, ESLint, Prettier, Vitest)

### Next Steps
1. Implement functionality for each tab (Local Assets, Model Browser, Outputs)
2. Create API endpoints for backend communication
3. Develop asset management operations
4. Add external platform integrations (CivitAI, HuggingFace)

## Troubleshooting

### Common Issues
- **Build failures**: Check TypeScript errors and ESLint warnings
- **Extension not loading**: Verify ComfyUI app initialization timing
- **Translation missing**: Check locale file structure and i18n configuration
- **Styling issues**: Ensure CSS classes are compatible with ComfyUI theme

### Development Tips
- Use `npm run watch` for continuous building during development
- Check browser console for ComfyUI extension registration messages
- Verify `dist/` directory structure matches expected output
- Test with both development and production builds

---

*This guide is maintained as part of the project's memory bank system. Update when significant changes are made to architecture, tooling, or development processes.*